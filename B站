// ==UserScript==
// @name 哔哩哔哩移动版
// @namespace Violentmonkey Scripts
// @match https://*.bilibili.com/*
// @grant none
// @version 1.2
// @author Donald
// ==/UserScript==

(function(){
    // PC版网页缩放
    let hostname = window.location.hostname
    let pcPageList = [
      'space.bilibili.com',
      't.bilibili.com'
    ]
    pcPageList.forEach(function(item){
      if (hostname.match(item)) {
        let meta = document.createElement('meta')
        meta.name = 'viewport'
        meta.content = 'width=device-width; initial-scale=1.0'
        document.head.appendChild(meta)
      }
    })
  
    // 根据页面选择样式
    let pathname = window.location.pathname
    let pageFilter = ''
    let list = [
      {name: '/video/', target: ',.v-affix'}
    ]
    list.some(function(item){
      if (pathname.match(item.name)) {
        pageFilter += item.target
      }
    })
    
    // 播放页优化
    let style = `
        .m-navbar {
            position: fixed;
            width: 100%;
            z-index: 999;
            top: 0;
        }
        .channel-menu {
            margin-top: 11.7vw;
        }
        .m-video-player {
            position: fixed;
            z-index: 999;
            margin-top: 11.73333vw;
            top: 0;
        }
        .m-video-info-new {
            margin-top: 72%;
        }
        .m-footer
        `+pageFilter+`
        {
            display: none !important;
        }
    `
    document.querySelector('style').innerText += style
  
    // 首页、排行榜 新窗口打开
    document.addEventListener('readystatechange', function(){
        clear()
    })

    function clear() {
        console.log('clear.............')
        document.querySelectorAll('.v-card').forEach(function(item){
            item.target = '_blank'
        })
        document.querySelectorAll('.v-card-single').forEach(function(item){
            item.target = '_blank'
        })
    }

    window.document.onscroll = function() {
        console.log('onscroll..........')
        let t1 = 0, t2 = 0, timer
        t1 = window.document.documentElement.scrollTop
        timer = setTimeout(function(){
            t2 = window.document.documentElement.scrollTop
            // 停止滚动
            if (t1 == t2) {
                clear()
            }
        }, 100)
    }

    let origOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function() {
        console.log('XHREvent........')
        this.addEventListener('load', function() {
            clear()
            // console.log(this.readyState); //will always be 4 (ajax is completed successfully)
            // console.log(this.responseText); //whatever the response was
        })
        origOpen.apply(this, arguments)
    }
  
})();
  
